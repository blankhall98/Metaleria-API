{% extends "base.html" %}

{% block title %}Nueva nota{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <p class="text-uppercase text-muted small mb-1">Operación</p>
        <h1 class="h4 text-white mb-0">Nueva nota</h1>
    </div>
    <a href="/web/worker/notes" class="btn btn-outline-secondary btn-sm">Volver</a>
</div>

{% if error %}
    <div class="alert alert-danger py-2 small">
        {{ error }}
    </div>
{% endif %}
<div id="evidence-alert" class="alert alert-warning py-2 small d-none"></div>

<div class="card hover-lift worker-note-card">
    <div class="card-body">
        <form method="post" class="worker-note-form d-grid gap-4" oninput="updateSteps()">
            <section class="step-card worker-step-card" id="step1">
                <div class="note-step-header">
                    <span class="chip-strong note-step-pill">Paso 1</span>
                    <div>
                        <div class="note-step-title">Define operaci&oacute;n y partner</div>
                        <div class="note-step-sub">Selecciona la operaci&oacute;n y el contacto correcto.</div>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-lg-4">
                        <div class="note-step-panel">
                            <label class="form-label" for="tipo_operacion">Tipo de operaci&oacute;n</label>
                            <select class="form-select" id="tipo_operacion" name="tipo_operacion" required onchange="togglePartner(); updateSteps();">
                                <option value="compra">Compra</option>
                                <option value="venta">Venta</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="note-step-panel">
                            <label class="form-label">Partner</label>
                            <div class="d-flex flex-column flex-md-row gap-2">
                                <select class="form-select" id="proveedor_id" name="proveedor_id">
                                    <option value="">Proveedor (compra)</option>
                                    {% for p in proveedores %}
                                        <option value="{{ p.id }}">{{ p.nombre_completo }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select" id="cliente_id" name="cliente_id">
                                    <option value="">Cliente (venta)</option>
                                    {% for c in clientes %}
                                        <option value="{{ c.id }}">{{ c.nombre_completo }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <small class="text-muted">Solo selecciona uno segun la operacion.</small>
                        </div>
                    </div>
                </div>
            </section>

            <section class="step-card worker-step-card disabled" id="step2">
                <div class="note-step-header">
                    <span class="chip-strong note-step-pill">Paso 2</span>
                    <div>
                        <div class="note-step-title">Materiales y subpesajes</div>
                        <div class="note-step-sub">Agrega los pesos y la evidencia de cada material.</div>
                    </div>
                </div>

                <div id="materiales-wrapper" class="d-grid gap-3 mb-3">
                    <div class="material-row material-card worker-material-card">
                        <div class="material-header">
                            <div>
                                <div class="material-title">Material</div>
                                <div class="material-sub">Agrega subpesajes y evidencia.</div>
                            </div>
                            <button type="button" class="btn btn-sm remove-btn" onclick="removeMaterial(this)">Eliminar material</button>
                        </div>
                        <div class="row g-2">
                            <div class="col-12">
                                <label class="form-label">Material</label>
                                <select class="form-select" name="material_id" required>
                                    <option value="">Selecciona material</option>
                                    {% for m in materiales %}
                                        <option value="{{ m.id }}">{{ m.nombre }} ({{ m.unidad_medida }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Tipo de precio</label>
                                <select class="form-select" name="tipo_cliente">
                                    <option value="">Regular</option>
                                    <option value="mayorista">Mayorista</option>
                                    <option value="menudeo">Menudeo</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Subpesajes</label>
                                <div class="subpesaje-panel">
                                    <div class="d-grid gap-2 subpesajes-wrapper">
                                        <div class="input-group flex-wrap align-items-center subpesaje-group">
                                            <span class="input-group-text">Peso bruto</span>
                                            <input class="form-control subpesaje-input" type="number" step="0.01" min="0.01" placeholder="Ej. 150.25" oninput="updatePesajes(this)">
                                            <span class="input-group-text">Desc. kg</span>
                                            <input class="form-control subpesaje-desc" type="number" step="0.01" min="0" placeholder="0.00" oninput="updatePesajes(this)">
                                            <span class="input-group-text bg-light">Neto</span>
                                            <span class="input-group-text subpesaje-neto">0.00</span>
                                            <input class="subpesaje-evid d-none" type="file" accept="image/*" data-capture="environment" onchange="handleEvidenceChange(this)">
                                            <button type="button" class="evidence-btn" onclick="triggerEvidence(this)" title="Tomar o seleccionar foto">
                                                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                                                    <path d="M9 4.5 7.8 6H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2.8L15 4.5H9Zm3 10.75a3.25 3.25 0 1 1 0-6.5 3.25 3.25 0 0 1 0 6.5Z" fill="currentColor"/>
                                                </svg>
                                            </button>
                                            <img class="evid-thumb d-none" alt="Evidencia">
                                            <span class="input-group-text bg-light evid-label">Sin foto</span>
                                            <button type="button" class="btn btn-outline-danger" onclick="removePesaje(this)">Eliminar</button>
                                        </div>
                                    </div>
                                    <div class="subpesaje-actions">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPesaje(this)">Agregar pesaje</button>
                                    </div>
                                    <input type="hidden" name="subpesajes" value="">
                                    <div class="form-text">Ingresa peso bruto y descuento; el neto se calcula solo. Sube la evidencia desde tu galer&iacute;a o c&aacute;mara.</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Kg bruto total (auto)</label>
                                <input class="form-control" type="number" step="0.01" min="0" name="kg_bruto" readonly>
                                <div class="form-text">Suma de todos los pesajes brutos.</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Kg descuento total (auto)</label>
                                <input class="form-control" type="number" step="0.01" min="0" name="kg_descuento" value="0" readonly>
                            </div>
                            <div class="col-12">
                                <div class="material-summary border rounded p-2 bg-white">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">Kg bruto</span>
                                        <strong class="kg-bruto">0.00</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">Kg descuento</span>
                                        <strong class="kg-desc">0.00</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">Kg neto</span>
                                        <strong class="kg-neto">0.00</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">Total $ (se calculará)</span>
                                        <strong class="total-material text-muted">-</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMaterial()">Agregar material</button>
                </div>
                <div class="note-summary-panel border rounded p-3 bg-white mt-3">
                    <h3 class="h6 mb-2">Resumen de la nota (auto)</h3>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted small">Kg bruto</span>
                        <strong id="nota-kg-bruto">0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted small">Kg descuento</span>
                        <strong id="nota-kg-desc">0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted small">Kg neto</span>
                        <strong id="nota-kg-neto">0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted small">Total $</span>
                        <strong id="nota-total" class="text-muted">-</strong>
                    </div>
                </div>
            </section>

            <section class="step-card worker-step-card disabled" id="step3">
                <div class="note-step-header">
                    <span class="chip-strong note-step-pill">Paso 3</span>
                    <div>
                        <div class="note-step-title">Comentarios</div>
                        <div class="note-step-sub">Agrega contexto adicional para el revisor.</div>
                    </div>
                </div>
                <div class="note-step-panel">
                    <textarea class="form-control" id="comentarios_trabajador" name="comentarios_trabajador" rows="2" placeholder="Notas para el revisor (opcional)" disabled></textarea>
                </div>
            </section>

            <section class="step-card worker-step-card" id="step4">
                <div class="note-step-header">
                    <span class="chip-strong note-step-pill">Paso 4</span>
                    <div>
                        <div class="note-step-title">Evidencia extra</div>
                        <div class="note-step-sub">Agrega fotos adicionales para respaldar la nota.</div>
                    </div>
                </div>
                <div class="note-step-panel">
                    <div class="d-flex flex-column flex-sm-row gap-2 align-items-sm-center justify-content-between">
                        <div class="text-muted small">Fotos cargadas: <strong id="extra-evidence-count">0</strong></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="triggerExtraEvidence()">Agregar fotos</button>
                    </div>
                    <input class="d-none" type="file" id="extra_evidence_input" accept="image/*" multiple>
                    <input type="hidden" name="extra_evidencias" id="extra_evidencias" value="[]">
                    <div id="extra-evidence-list" class="extra-evidence-grid mt-3"></div>
                    <div class="form-text">Puedes seleccionar varias fotos desde tu galer&iacute;a. Max {{ max_mb }}MB por imagen.</div>
                </div>
            </section>

            <div class="note-submit-panel d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>Guardar borrador</button>
                <small class="text-muted">Este registro quedará en estado borrador y será visible para revisión.</small>
            </div>
        </form>
    </div>
</div>

<div class="evidence-picker-modal" id="workerEvidencePickerModal" aria-hidden="true">
    <div class="evidence-picker-backdrop" data-evidence-close></div>
    <div class="evidence-picker-card" role="dialog" aria-modal="true" aria-labelledby="workerEvidencePickerTitle">
        <div class="evidence-picker-header">
            <h3 id="workerEvidencePickerTitle">Agregar evidencia</h3>
            <button type="button" class="evidence-picker-close" data-evidence-close aria-label="Cerrar">&times;</button>
        </div>
        <p class="text-muted small mb-0">Elige c&oacute;mo quieres subir la foto.</p>
        <div class="evidence-picker-actions">
            <button type="button" class="btn btn-primary w-100" data-evidence-option="camera">Tomar foto</button>
            <button type="button" class="btn btn-outline-primary w-100" data-evidence-option="gallery">Elegir de la galer&iacute;a</button>
        </div>
        <div class="evidence-picker-hint text-muted small">Formatos JPG/PNG. Max {{ max_mb }}MB.</div>
    </div>
</div>

<script>
    const PRICE_MAP = {{ price_map | tojson | safe }};
    const MAX_MB = {{ max_mb | default(8) }};
    const UPLOAD_URL = '/web/files/upload';
    let pendingUploads = 0;
    const evidenceModal = document.getElementById('workerEvidencePickerModal');
    let activeEvidenceInput = null;
    const extraEvidenceInput = document.getElementById('extra_evidence_input');
    const extraEvidenceList = document.getElementById('extra-evidence-list');
    const extraEvidenceHidden = document.getElementById('extra_evidencias');
    const extraEvidenceCount = document.getElementById('extra-evidence-count');
    let extraEvidenceUrls = [];

    function openEvidenceModal(inputEl) {
        if (!evidenceModal || !inputEl) return;
        activeEvidenceInput = inputEl;
        evidenceModal.classList.add('is-open');
        evidenceModal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
    }
    function closeEvidenceModal() {
        if (!evidenceModal) return;
        evidenceModal.classList.remove('is-open');
        evidenceModal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        activeEvidenceInput = null;
    }
    if (evidenceModal) {
        evidenceModal.querySelectorAll('[data-evidence-close]').forEach((btn) => {
            btn.addEventListener('click', closeEvidenceModal);
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeEvidenceModal();
        });
        evidenceModal.querySelectorAll('[data-evidence-option]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const targetInput = activeEvidenceInput;
                if (!targetInput) return;
                const choice = btn.getAttribute('data-evidence-option');
                if (choice === 'camera') {
                    const cap = targetInput.dataset.capture || 'environment';
                    targetInput.setAttribute('capture', cap);
                } else {
                    targetInput.removeAttribute('capture');
                }
                closeEvidenceModal();
                targetInput.click();
            });
        });
    }

    function showEvidenceAlert(message, kind) {
        const alertEl = document.getElementById('evidence-alert');
        if (!alertEl) return;
        alertEl.textContent = message;
        alertEl.classList.remove('d-none', 'alert-warning', 'alert-danger', 'alert-success');
        const cls = kind ? `alert-${kind}` : 'alert-warning';
        alertEl.classList.add(cls);
    }
    function clearEvidenceAlert() {
        const alertEl = document.getElementById('evidence-alert');
        if (!alertEl) return;
        alertEl.textContent = '';
        alertEl.classList.add('d-none');
    }
    function triggerEvidence(btn) {
        const group = btn.closest('.input-group');
        const input = group ? group.querySelector('.subpesaje-evid') : null;
        if (!input) return;
        if (!evidenceModal) {
            input.click();
            return;
        }
        openEvidenceModal(input);
    }
    function setEvidenceLabel(groupEl, text, state) {
        const label = groupEl ? groupEl.querySelector('.evid-label') : null;
        if (!label) return;
        label.textContent = text;
        label.classList.remove('is-uploading', 'is-error', 'is-ready');
        if (state === 'uploading') label.classList.add('is-uploading');
        if (state === 'error') label.classList.add('is-error');
        if (state === 'ready') label.classList.add('is-ready');
    }
    function handleEvidenceChange(inputEl) {
        const file = inputEl.files && inputEl.files[0];
        const group = inputEl.closest('.input-group');
        if (!file || !group) return;
        clearEvidenceAlert();
        if (file.size > MAX_MB * 1024 * 1024) {
            inputEl.value = '';
            inputEl.dataset.error = '1';
            inputEl.dataset.url = '';
            inputEl.dataset.uploading = '';
            setEvidenceLabel(group, `Imagen muy pesada (max ${MAX_MB}MB).`, 'error');
            showEvidenceAlert(`La imagen supera ${MAX_MB}MB. Usa un archivo m&aacute;s ligero.`, 'warning');
            updatePesajes(inputEl);
            return;
        }
        inputEl.dataset.error = '';
        inputEl.dataset.uploading = '1';
        inputEl.dataset.url = '';
        setEvidenceLabel(group, 'Subiendo...', 'uploading');
        const thumb = group.querySelector('.evid-thumb');
        if (thumb) {
            const objectUrl = URL.createObjectURL(file);
            thumb.src = objectUrl;
            thumb.dataset.local = '1';
            thumb.classList.remove('d-none');
            thumb.onload = () => URL.revokeObjectURL(objectUrl);
        }
        pendingUploads += 1;
        updateSteps();
        uploadEvidence(inputEl, file);
    }
    async function uploadEvidence(inputEl, file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch(UPLOAD_URL, { method: 'POST', body: formData });
            if (!response.ok) {
                let detail = '';
                try {
                    const data = await response.json();
                    detail = data.detail || '';
                } catch (err) {
                    detail = '';
                }
                throw new Error(detail || 'No se pudo subir la imagen.');
            }
            const data = await response.json();
            if (!data.url) {
                throw new Error('Respuesta sin URL.');
            }
            clearEvidenceAlert();
            inputEl.dataset.url = data.url;
            inputEl.dataset.error = '';
            setEvidenceLabel(inputEl.closest('.input-group'), 'Evidencia cargada', 'ready');
        } catch (err) {
            inputEl.dataset.error = '1';
            inputEl.dataset.url = '';
            setEvidenceLabel(inputEl.closest('.input-group'), 'Error al subir', 'error');
            showEvidenceAlert('No se pudo subir la evidencia. Intenta de nuevo.', 'danger');
        } finally {
            inputEl.dataset.uploading = '';
            pendingUploads = Math.max(0, pendingUploads - 1);
            updatePesajes(inputEl);
            updateSteps();
        }
    }

    function triggerExtraEvidence() {
        if (!extraEvidenceInput) return;
        extraEvidenceInput.click();
    }
    function renderExtraEvidence() {
        if (!extraEvidenceHidden) return;
        extraEvidenceHidden.value = JSON.stringify(extraEvidenceUrls);
        if (extraEvidenceCount) {
            extraEvidenceCount.textContent = String(extraEvidenceUrls.length);
        }
        if (!extraEvidenceList) return;
        extraEvidenceList.innerHTML = '';
        if (extraEvidenceUrls.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'text-muted small';
            empty.textContent = 'Sin evidencia extra por ahora.';
            extraEvidenceList.appendChild(empty);
            return;
        }
        extraEvidenceUrls.forEach((url, index) => {
            const item = document.createElement('div');
            item.className = 'extra-evidence-item';
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Evidencia extra';
            img.loading = 'lazy';
            img.className = 'extra-evidence-thumb';
            const actions = document.createElement('div');
            actions.className = 'extra-evidence-actions';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-outline-danger btn-sm';
            removeBtn.textContent = 'Quitar';
            removeBtn.addEventListener('click', () => {
                extraEvidenceUrls.splice(index, 1);
                renderExtraEvidence();
            });
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.className = 'small text-muted';
            link.textContent = 'Ver';
            actions.appendChild(link);
            actions.appendChild(removeBtn);
            item.appendChild(img);
            item.appendChild(actions);
            extraEvidenceList.appendChild(item);
        });
    }
    async function uploadExtraEvidenceFiles(files) {
        for (const file of files) {
            if (!file) continue;
            if (file.size > MAX_MB * 1024 * 1024) {
                showEvidenceAlert(`La imagen supera ${MAX_MB}MB. Usa un archivo mas ligero.`, 'warning');
                continue;
            }
            pendingUploads += 1;
            updateSteps();
            try {
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetch(UPLOAD_URL, { method: 'POST', body: formData });
                if (!response.ok) {
                    let detail = '';
                    try {
                        const data = await response.json();
                        detail = data.detail || '';
                    } catch (err) {
                        detail = '';
                    }
                    throw new Error(detail || 'No se pudo subir la imagen.');
                }
                const data = await response.json();
                if (!data.url) {
                    throw new Error('Respuesta sin URL.');
                }
                clearEvidenceAlert();
                extraEvidenceUrls.push(data.url);
                renderExtraEvidence();
            } catch (err) {
                showEvidenceAlert('No se pudo subir la evidencia extra. Intenta de nuevo.', 'danger');
            } finally {
                pendingUploads = Math.max(0, pendingUploads - 1);
                updateSteps();
            }
        }
    }
    if (extraEvidenceInput) {
        extraEvidenceInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files || []);
            event.target.value = '';
            if (files.length === 0) return;
            uploadExtraEvidenceFiles(files);
        });
    }
    function togglePartner() {
        const tipo = document.getElementById('tipo_operacion').value;
        const proveedorSel = document.getElementById('proveedor_id');
        const clienteSel = document.getElementById('cliente_id');
        if (tipo === 'compra') {
            proveedorSel.removeAttribute('disabled');
            clienteSel.setAttribute('disabled', 'disabled');
            clienteSel.value = '';
        } else {
            clienteSel.removeAttribute('disabled');
            proveedorSel.setAttribute('disabled', 'disabled');
            proveedorSel.value = '';
        }
    }
    function addMaterial() {
        const wrapper = document.getElementById('materiales-wrapper');
        const tpl = wrapper.querySelector('.material-row');
        const clone = tpl.cloneNode(true);
        // limpiar selects/inputs
        clone.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);
        clone.querySelectorAll('input').forEach(inp => {
            if (inp.type === 'hidden') inp.value = '';
            else if (inp.name === 'kg_descuento') inp.value = '0';
            else inp.value = '';
        });
        clone.querySelectorAll('.subpesaje-evid').forEach(inp => {
            inp.dataset.url = '';
            inp.dataset.uploading = '';
            inp.dataset.error = '';
        });
        clone.querySelectorAll('.evid-thumb').forEach(img => {
            img.removeAttribute('src');
            img.dataset.local = '';
            img.classList.add('d-none');
        });
        const evidLabel = clone.querySelector('.evid-label');
        if (evidLabel) {
            evidLabel.textContent = 'Sin foto';
            evidLabel.classList.remove('is-uploading', 'is-error', 'is-ready');
        }
        // reset subpesajes a solo una fila vacía
        const subWrapper = clone.querySelector('.subpesajes-wrapper');
        subWrapper.innerHTML = `
            <div class="input-group flex-wrap align-items-center subpesaje-group">
                <span class="input-group-text">Peso bruto</span>
                <input class="form-control subpesaje-input" type="number" step="0.01" min="0.01" placeholder="Ej. 150.25" oninput="updatePesajes(this)">
                <span class="input-group-text">Desc. kg</span>
                <input class="form-control subpesaje-desc" type="number" step="0.01" min="0" placeholder="0.00" oninput="updatePesajes(this)">
                <span class="input-group-text bg-light">Neto</span>
                <span class="input-group-text subpesaje-neto">0.00</span>
                <input class="subpesaje-evid d-none" type="file" accept="image/*" data-capture="environment" onchange="handleEvidenceChange(this)">
                <button type="button" class="evidence-btn" onclick="triggerEvidence(this)" title="Tomar o seleccionar foto">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                        <path d="M9 4.5 7.8 6H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2.8L15 4.5H9Zm3 10.75a3.25 3.25 0 1 1 0-6.5 3.25 3.25 0 0 1 0 6.5Z" fill="currentColor"/>
                    </svg>
                </button>
                <img class="evid-thumb d-none" alt="Evidencia">
                <span class="input-group-text bg-light evid-label">Sin foto</span>
                <button type="button" class="btn btn-outline-danger" onclick="removePesaje(this)">Eliminar</button>
            </div>
        `;
        // reset resúmenes por material
        clone.querySelector('.kg-bruto').textContent = '0.00';
        clone.querySelector('.kg-desc').textContent = '0.00';
        clone.querySelector('.kg-neto').textContent = '0.00';
        clone.querySelector('.total-material').textContent = '-';
        wrapper.appendChild(clone);
        updateSteps();
    }
    function removeMaterial(btn) {
        const rows = document.querySelectorAll('#materiales-wrapper .material-row');
        if (rows.length <= 1) return; // mantener al menos uno
        btn.closest('.material-row').remove();
        updateSteps();
    }
    function updatePesajes(inputEl) {
        const materialRow = inputEl.closest('.material-row');
        const inputs = materialRow.querySelectorAll('.subpesaje-input');
        const descInputs = materialRow.querySelectorAll('.subpesaje-desc');
        const evidInputs = materialRow.querySelectorAll('.subpesaje-evid');
        const hidden = materialRow.querySelector('input[type="hidden"][name="subpesajes"]');
        let items = [];
        for (let idx = 0; idx < inputs.length; idx++) {
            const bruto = parseFloat(inputs[idx].value || '0');
            const desc = parseFloat(descInputs[idx].value || '0');
            const evidInput = evidInputs[idx];
            const evidenciaUrl = evidInput.dataset.url || '';
            const isUploading = evidInput.dataset.uploading === '1';
            const hasError = evidInput.dataset.error === '1';
            const netoPesaje = Math.max(bruto - desc, 0);
            const groupEl = evidInput.closest('.input-group');
            const netoLabel = groupEl?.querySelector('.subpesaje-neto');
            const evidLabel = groupEl?.querySelector('.evid-label');
            if (netoLabel) netoLabel.textContent = netoPesaje.toFixed(2);
            if (evidLabel) {
                evidLabel.classList.remove('is-uploading', 'is-error', 'is-ready');
                if (isUploading) {
                    evidLabel.textContent = 'Subiendo...';
                    evidLabel.classList.add('is-uploading');
                } else if (hasError) {
                    evidLabel.textContent = 'Error al subir';
                    evidLabel.classList.add('is-error');
                } else if (evidenciaUrl) {
                    evidLabel.textContent = 'Evidencia cargada';
                    evidLabel.classList.add('is-ready');
                } else {
                    evidLabel.textContent = 'Sin foto';
                }
            }
            if (bruto > 0 || desc > 0 || evidenciaUrl) {
                items.push({peso_kg: bruto || 0, descuento_kg: desc || 0, foto_url: evidenciaUrl || null});
            }
        }
        hidden.value = JSON.stringify(items);
        const totalBruto = items.reduce((acc, it) => acc + (it.peso_kg || 0), 0);
        const totalDesc = items.reduce((acc, it) => acc + (it.descuento_kg || 0), 0);
        const totalNeto = Math.max(totalBruto - totalDesc, 0);
        const kgBrutoInput = materialRow.querySelector('input[name=\"kg_bruto\"]');
        const kgDescInput = materialRow.querySelector('input[name=\"kg_descuento\"]');
        kgBrutoInput.value = totalBruto > 0 ? totalBruto.toFixed(2) : '';
        kgDescInput.value = totalDesc > 0 ? totalDesc.toFixed(2) : '0';
        materialRow.querySelector('.kg-bruto').textContent = kgBrutoInput.value || '0.00';
        materialRow.querySelector('.kg-desc').textContent = kgDescInput.value || '0.00';
        materialRow.querySelector('.kg-neto').textContent = totalNeto > 0 ? totalNeto.toFixed(2) : '0.00';
        // precio por material
        const tipoOp = document.getElementById('tipo_operacion').value;
        const tipoCli = materialRow.querySelector('select[name=\"tipo_cliente\"]').value || 'regular';
        const matId = parseInt(materialRow.querySelector('select[name=\"material_id\"]').value || '0');
        let subtotalText = '-';
        if (PRICE_MAP[matId] && PRICE_MAP[matId][tipoOp]) {
            const priceMap = PRICE_MAP[matId][tipoOp];
            const price = priceMap[tipoCli] ?? priceMap['regular'];
            if (price !== undefined && price !== null) {
                const subtotal = totalNeto * parseFloat(price);
                subtotalText = `$${subtotal.toFixed(2)}`;
            }
        }
        materialRow.querySelector('.total-material').textContent = subtotalText;
        updateSteps();
    }
    function addPesaje(btn) {
        const materialRow = btn.closest('.material-row');
        const wrapper = materialRow.querySelector('.subpesajes-wrapper');
        const group = document.createElement('div');
        group.className = 'input-group flex-wrap align-items-center subpesaje-group';
        group.innerHTML = `
            <span class="input-group-text">Peso bruto</span>
            <input class="form-control subpesaje-input" type="number" step="0.01" min="0.01" placeholder="Ej. 150.25" oninput="updatePesajes(this)">
            <span class="input-group-text">Desc. kg</span>
            <input class="form-control subpesaje-desc" type="number" step="0.01" min="0" placeholder="0.00" oninput="updatePesajes(this)">
            <span class="input-group-text bg-light">Neto</span>
            <span class="input-group-text subpesaje-neto">0.00</span>
                <input class="subpesaje-evid d-none" type="file" accept="image/*" data-capture="environment" onchange="handleEvidenceChange(this)">
            <button type="button" class="evidence-btn" onclick="triggerEvidence(this)" title="Tomar o seleccionar foto">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                    <path d="M9 4.5 7.8 6H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2.8L15 4.5H9Zm3 10.75a3.25 3.25 0 1 1 0-6.5 3.25 3.25 0 0 1 0 6.5Z" fill="currentColor"/>
                </svg>
            </button>
            <img class="evid-thumb d-none" alt="Evidencia">
            <span class="input-group-text bg-light evid-label">Sin foto</span>
            <button type="button" class="btn btn-outline-danger" onclick="removePesaje(this)">Eliminar</button>
        `;
        wrapper.appendChild(group);
    }
    function removePesaje(btn) {
        const group = btn.closest('.input-group');
        const materialRow = btn.closest('.material-row');
        const wrapper = materialRow.querySelector('.subpesajes-wrapper');
        if (wrapper.querySelectorAll('.input-group').length <= 1) {
            const inputs = wrapper.querySelectorAll('input');
            inputs.forEach(i => i.value = '');
            const evidInput = wrapper.querySelector('.subpesaje-evid');
            if (evidInput) {
                evidInput.dataset.url = '';
                evidInput.dataset.uploading = '';
                evidInput.dataset.error = '';
                const groupEl = evidInput.closest('.input-group');
                const evidLabel = groupEl ? groupEl.querySelector('.evid-label') : null;
                if (evidLabel) {
                    evidLabel.textContent = 'Sin foto';
                    evidLabel.classList.remove('is-uploading', 'is-error', 'is-ready');
                }
                const thumb = groupEl ? groupEl.querySelector('.evid-thumb') : null;
                if (thumb) {
                    thumb.removeAttribute('src');
                    thumb.dataset.local = '';
                    thumb.classList.add('d-none');
                }
            }
            updatePesajes(wrapper.querySelector('.subpesaje-input'));
            return;
        }
        group.remove();
        const input = wrapper.querySelector('.subpesaje-input');
        if (input) updatePesajes(input);
    }
    function isStep1Valid() {
        const tipo = document.getElementById('tipo_operacion').value;
        const prov = document.getElementById('proveedor_id').value;
        const cli = document.getElementById('cliente_id').value;
        if (tipo === 'compra') {
            return prov !== '';
        }
        return cli !== '';
    }
    function isStep2Valid() {
        const rows = document.querySelectorAll('#materiales-wrapper .material-row');
        if (rows.length === 0) return false;
        for (const row of rows) {
            const mat = row.querySelector('select[name=\"material_id\"]').value;
            const kgBruto = parseFloat(row.querySelector('input[name=\"kg_bruto\"]').value || '0');
            const kgDesc = parseFloat(row.querySelector('input[name=\"kg_descuento\"]').value || '0');
            if (!mat || kgBruto <= 0 || kgDesc < 0 || kgDesc > kgBruto) {
                return false;
            }
        }
        return true;
    }
    function enableStep(stepEl, enabled) {
        if (enabled) {
            stepEl.classList.remove('disabled');
            stepEl.querySelectorAll('input, select, textarea, button').forEach(el => el.removeAttribute('disabled'));
        } else {
            stepEl.classList.add('disabled');
            stepEl.querySelectorAll('input, select, textarea, button').forEach(el => el.setAttribute('disabled', 'disabled'));
        }
    }
    function updateSteps() {
        const step1Valid = isStep1Valid();
        const step2El = document.getElementById('step2');
        const step3El = document.getElementById('step3');
        enableStep(step2El, step1Valid);

        const step2Valid = step1Valid && isStep2Valid();
        enableStep(step3El, step2Valid);

        // Resumen general
        const rows = document.querySelectorAll('#materiales-wrapper .material-row');
        let totBruto = 0, totDesc = 0, totNeto = 0, totMonto = 0;
        let tienePrecio = false;
        const tipoOp = document.getElementById('tipo_operacion').value;
        rows.forEach(row => {
            const kgBr = parseFloat(row.querySelector('input[name="kg_bruto"]').value || '0');
            const kgDe = parseFloat(row.querySelector('input[name="kg_descuento"]').value || '0');
            const kgNe = parseFloat(row.querySelector('.kg-neto').textContent || '0');
            totBruto += kgBr;
            totDesc += kgDe;
            totNeto += kgNe;

            const matId = parseInt(row.querySelector('select[name="material_id"]').value || '0');
            const tipoCli = row.querySelector('select[name="tipo_cliente"]').value || 'regular';
            if (PRICE_MAP[matId] && PRICE_MAP[matId][tipoOp]) {
                const priceMap = PRICE_MAP[matId][tipoOp];
                const price = priceMap[tipoCli] ?? priceMap['regular'];
                if (price !== undefined && price !== null) {
                    totMonto += kgNe * parseFloat(price);
                    tienePrecio = true;
                }
            }
        });
        document.getElementById('nota-kg-bruto').textContent = totBruto.toFixed(2);
        document.getElementById('nota-kg-desc').textContent = totDesc.toFixed(2);
        document.getElementById('nota-kg-neto').textContent = totNeto.toFixed(2);
        document.getElementById('nota-total').textContent = tienePrecio ? `$${totMonto.toFixed(2)}` : '-';

        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            const blocked = pendingUploads > 0;
            submitBtn.disabled = !step2Valid || blocked;
            submitBtn.textContent = blocked ? 'Subiendo evidencias...' : 'Guardar borrador';
        }
    }
    const formEl = document.querySelector('form');
    if (formEl) {
        formEl.addEventListener('submit', (event) => {
            if (pendingUploads > 0) {
                event.preventDefault();
                showEvidenceAlert('Espera a que terminen las cargas de evidencia.', 'warning');
            }
        });
    }
    // inicializar partner visible y steps
    togglePartner();
    updateSteps();
    renderExtraEvidence();
</script>
{% endblock %}
