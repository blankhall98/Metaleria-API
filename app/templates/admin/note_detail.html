{% extends "base.html" %}

{% block title %}Nota {{ nota.id }}{% endblock %}

{% block content %}
<div class="note-detail-page">
<div class="page-header">
    <div>
        <p class="text-uppercase text-muted small mb-1">Revisi&oacute;n</p>
        <h1 class="h4 text-dark mb-0">Nota #{{ nota.id }}</h1>
    </div>
    <div class="d-flex gap-2">
        <a href="/web/admin/notas/{{ nota.id }}/evidencias" class="btn btn-primary btn-sm note-evidence-btn">Evidencias</a>
        <a href="/web/admin/notas" class="btn btn-outline-secondary btn-sm">Volver</a>
    </div>
</div>

<div class="card hover-lift mb-3 note-summary-card">
    <div class="card-body">
        {% if error %}
            <div class="alert alert-danger py-2 small mb-3">{{ error }}</div>
        {% endif %}
        {% if precios_updated %}
            <div class="alert alert-success py-2 small mb-3">Precios actualizados.</div>
        {% endif %}
        <div class="note-meta-grid">
            <div class="note-meta-item">
                <span class="note-meta-label">Estado</span>
                {% if nota.estado.value == 'BORRADOR' %}
                    <span class="badge bg-secondary">Borrador</span>
                {% elif nota.estado.value == 'EN_REVISION' %}
                    <span class="badge bg-warning text-dark">En revisi&oacute;n</span>
                {% elif nota.estado.value == 'APROBADA' %}
                    <span class="badge bg-success">Aprobada</span>
                {% else %}
                    <span class="badge bg-danger">Cancelada</span>
                {% endif %}
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Operaci&oacute;n</span>
                <strong>{{ nota.tipo_operacion.value|capitalize }}</strong>
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Sucursal</span>
                <strong>{{ sucursal.nombre if sucursal else '-' }}</strong>
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Trabajador</span>
                <strong>{{ trabajador.nombre_completo if trabajador else '-' }}</strong>
                <div class="note-meta-sub">{{ trabajador.username if trabajador else '' }}</div>
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Fecha y hora</span>
                <strong>{{ nota.created_at.strftime("%Y-%m-%d %H:%M") if nota.created_at else '-' }}</strong>
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Partner</span>
                {% if nota.tipo_operacion.value == 'compra' %}
                    <strong>{{ proveedor.nombre_completo if proveedor else '-' }}</strong>
                {% else %}
                    <strong>{{ cliente.nombre_completo if cliente else '-' }}</strong>
                {% endif %}
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Kg neto</span>
                <strong>{{ "%.2f"|format(nota.total_kg_neto or 0) }} kg</strong>
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Total</span>
                <strong>${{ "%.2f"|format(nota.total_monto or 0) }}</strong>
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Monto pagado</span>
                <strong>${{ "%.2f"|format(nota.monto_pagado or 0) }}</strong>
            </div>
            <div class="note-meta-item">
                <span class="note-meta-label">Saldo pendiente</span>
                {% if saldo_pendiente > 0 %}
                    <strong class="text-danger">${{ "%.2f"|format(saldo_pendiente) }}</strong>
                {% else %}
                    <strong class="text-success">$0.00</strong>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="card hover-lift mb-3 note-report-card">
    <div class="card-body">
        <form method="post" action="/web/admin/notas/{{ nota.id }}/aprobar" id="approveForm">
            <h2 class="h6 text-dark mb-3 note-section-title">Materiales</h2>
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0 note-table">
                    <thead>
                    <tr>
                        <th>Material</th>
                        <th class="text-end">Kg bruto</th>
                        <th class="text-end">Kg desc</th>
                        <th class="text-end">Kg neto</th>
                        <th>Tipo precio</th>
                        <th class="text-end">Precio unit</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for m in nota.materiales %}
                        <tr>
                            <td>{{ m.material.nombre if m.material else m.material_id }}</td>
                            <td class="text-end">{{ "%.2f"|format(m.kg_bruto or 0) }}</td>
                            <td class="text-end">{{ "%.2f"|format(m.kg_descuento or 0) }}</td>
                            <td class="text-end">{{ "%.2f"|format(m.kg_neto or 0) }}</td>
                            <td>
                                <select class="form-select form-select-sm" name="tipo_cliente_{{ m.id }}">
                                    {% for tc in tipos_cliente %}
                                        {% set is_selected = (m.tipo_cliente and m.tipo_cliente.value == tc.value) or (not m.tipo_cliente and tc.value == 'regular') %}
                                        <option value="{{ tc.value }}" {% if is_selected %}selected{% endif %}>
                                            {{ tc.value|capitalize }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="text-end">{{ "%.2f"|format(m.precio_unitario or 0) if m.precio_unitario else '-' }}</td>
                            <td class="text-end">{{ "%.2f"|format(m.subtotal or 0) if m.subtotal else '-' }}</td>
                        </tr>
                        {% if m.subpesajes %}
                            <tr class="note-subpesaje-row">
                                <td colspan="7">
                                    <div class="note-subpesajes">
                                        <span class="note-subpesajes-label">Subpesajes</span>
                                        <div class="note-subpesajes-list">
                                            {% for sp in m.subpesajes %}
                                                <div class="note-subpesaje-item">
                                                    <span class="pill">{{ "%.2f"|format(sp.peso_kg) }} kg</span>
                                                    {% if sp.foto_url %}
                                                        <a href="{{ sp.foto_url }}" target="_blank" rel="noopener" class="note-subpesaje-link">Ver evidencia</a>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="row g-3 mt-3">
                <div class="col-md-3">
                    <label class="form-label">Fecha de caducidad de pago</label>
                    {% set fecha_val = form_fecha if form_fecha is not none else (nota.fecha_caducidad_pago.strftime("%Y-%m-%d") if nota.fecha_caducidad_pago else "") %}
                    <input class="form-control" type="date" name="fecha_caducidad_pago" value="{{ fecha_val }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">M&eacute;todo de pago</label>
                    {% set selected_metodo = form_metodo if form_metodo is not none else nota.metodo_pago %}
                    <select class="form-select" name="metodo_pago" id="metodo_pago_select" required>
                        <option value="" {% if not selected_metodo %}selected{% endif %}>Selecciona m&eacute;todo</option>
                        <option value="transferencia" {% if selected_metodo == 'transferencia' %}selected{% endif %}>Transferencia</option>
                        <option value="efectivo" {% if selected_metodo == 'efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="cheque" {% if selected_metodo == 'cheque' %}selected{% endif %}>Cheque</option>
                    </select>
                    <div class="form-text text-muted">La cuenta solo es necesaria para transferencia o cheque.</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Cuenta financiera</label>
                    {% set cuenta_val = form_cuenta if form_cuenta is not none else (nota.cuenta_financiera_id or "") %}
                    <input class="form-control" name="cuenta_financiera" id="cuenta_financiera_input" placeholder="ID o referencia de cuenta" value="{{ cuenta_val }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Pago inicial</label>
                    {% set pagado_val = form_pagado if form_pagado is not none else (nota.monto_pagado or "") %}
                    <input class="form-control" type="number" step="0.01" min="0" name="monto_pagado" value="{{ pagado_val }}">
                    <div class="form-text text-muted">Opcional. Aplica solo para notas a credito.</div>
                </div>
                <div class="col-12">
                    <label class="form-label">Comentarios admin</label>
                    {% set comentarios_val = form_comentarios if form_comentarios is not none else (nota.comentarios_admin or "") %}
                    <textarea class="form-control" name="comentarios_admin" rows="2" placeholder="Notas, m&eacute;todo de pago, cuenta financiera, motivo de rechazo, etc.">{{ comentarios_val }}</textarea>
                </div>
            </div>

        </form>
        <div class="note-actions">
            <div class="note-actions-title">Acciones</div>
            <div class="note-actions-row">
                <button type="submit" class="btn btn-primary note-action-primary" form="approveForm">Aprobar</button>
                <button type="submit"
                        class="btn btn-outline-primary"
                        form="approveForm"
                        formaction="/web/admin/notas/{{ nota.id }}/precios"
                        formnovalidate>
                    Actualizar precios
                </button>
            <form method="post" action="/web/admin/notas/{{ nota.id }}/cancelar" class="m-0" onsubmit="syncCancelComment(this)">
                <input type="hidden" name="comentarios_admin" value="">
                <button type="submit" class="btn btn-outline-danger">Rechazar</button>
            </form>
            {% if nota.estado.value in ['EN_REVISION'] %}
                <form method="post" action="/web/admin/notas/{{ nota.id }}/devolver" class="m-0">
                    <button type="submit" class="btn btn-outline-secondary">Devolver a borrador</button>
                </form>
            {% endif %}
            {% if user.rol == 'super_admin' %}
                <form method="post" action="/web/admin/notas/{{ nota.id }}/eliminar" class="m-0 ms-auto">
                    <button type="submit" class="btn btn-outline-secondary">Eliminar (solo SA)</button>
                </form>
            {% endif %}
            </div>
        </div>
    </div>
</div>

{% if nota.estado.value == 'APROBADA' %}
<div class="card hover-lift mb-3 note-payments-card">
    <div class="card-body">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
            <h2 class="h6 text-dark mb-0 note-section-title">Pagos registrados</h2>
            <div class="note-payment-summary">
                <span>Total: <strong>${{ "%.2f"|format(nota.total_monto or 0) }}</strong></span>
                <span>Saldo: <strong class="{{ 'text-danger' if saldo_pendiente > 0 else 'text-success' }}">${{ "%.2f"|format(saldo_pendiente) }}</strong></span>
            </div>
        </div>
        <form method="post" action="/web/admin/notas/{{ nota.id }}/pago" class="note-payment-form">
            <div class="row g-2 align-items-end">
                <div class="col-lg-3 col-md-4">
                    <label class="form-label">Monto</label>
                    {% set pago_monto_val = form_pago_monto if form_pago_monto is not none else "" %}
                    <input class="form-control form-control-sm" type="number" step="0.01" min="0" name="monto_pagado" value="{{ pago_monto_val }}" placeholder="0.00" required>
                </div>
                <div class="col-lg-3 col-md-4">
                    <label class="form-label">M&eacute;todo</label>
                    {% set pago_metodo_val = form_pago_metodo if form_pago_metodo else nota.metodo_pago %}
                    <select class="form-select form-select-sm" name="pago_metodo" id="pago_metodo_select">
                        <option value="" {% if not pago_metodo_val %}selected{% endif %}>Selecciona</option>
                        <option value="transferencia" {% if pago_metodo_val == 'transferencia' %}selected{% endif %}>Transferencia</option>
                        <option value="efectivo" {% if pago_metodo_val == 'efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="cheque" {% if pago_metodo_val == 'cheque' %}selected{% endif %}>Cheque</option>
                    </select>
                </div>
                <div class="col-lg-3 col-md-4">
                    <label class="form-label">Cuenta</label>
                    {% set pago_cuenta_val = form_pago_cuenta if form_pago_cuenta is not none else (nota.cuenta_financiera_id or "") %}
                    <input class="form-control form-control-sm" name="pago_cuenta" id="pago_cuenta_input" placeholder="ID o referencia" value="{{ pago_cuenta_val }}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Comentario</label>
                    {% set pago_comment_val = form_pago_comentario if form_pago_comentario is not none else "" %}
                    <input class="form-control form-control-sm" name="pago_comentario" placeholder="Opcional" value="{{ pago_comment_val }}">
                </div>
                <div class="col-lg-2 col-md-3 d-grid">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Agregar pago</button>
                </div>
                {% if pago_updated %}
                    <div class="col-12">
                        <span class="text-success small">Pago registrado correctamente.</span>
                    </div>
                {% endif %}
            </div>
        </form>
        <div class="table-responsive mt-3">
            <table class="table table-sm align-middle mb-0 note-payments-table">
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Monto</th>
                    <th>M&eacute;todo</th>
                    <th>Cuenta</th>
                    <th>Usuario</th>
                    <th>Comentario</th>
                </tr>
                </thead>
                <tbody>
                {% for pago in pagos %}
                    <tr>
                        <td>{{ pago.created_at.strftime("%Y-%m-%d %H:%M") if pago.created_at else '-' }}</td>
                        <td class="fw-semibold">${{ "%.2f"|format(pago.monto or 0) }}</td>
                        <td>{{ pago.metodo_pago|capitalize if pago.metodo_pago else '-' }}</td>
                        <td>{{ pago.cuenta_financiera or '-' }}</td>
                        <td>{{ pago.usuario.username if pago.usuario else (pago.usuario_id or '-') }}</td>
                        <td>{{ pago.comentario or '-' }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% if pagos|length == 0 %}
            <p class="text-muted small mb-0 mt-3">Aun no hay pagos registrados.</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if inv_movs and inv_movs|length > 0 %}
<div class="card hover-lift mb-3 note-report-card">
    <div class="card-body">
        <h2 class="h6 text-dark mb-3 note-section-title">Movimientos de inventario generados</h2>
        <div class="table-responsive">
            <table class="table table-sm align-middle mb-0 note-table">
                <thead>
                <tr>
                    <th>Sucursal</th>
                    <th>Material</th>
                    <th>Tipo</th>
                    <th class="text-end">Cantidad</th>
                    <th class="text-end">Saldo</th>
                    <th>Fecha</th>
                </tr>
                </thead>
                <tbody>
                {% for mov in inv_movs %}
                    <tr>
                        <td>{{ mov.inventario.sucursal.nombre if mov.inventario and mov.inventario.sucursal else '-' }}</td>
                        <td>{{ mov.inventario.material.nombre if mov.inventario and mov.inventario.material else '-' }}</td>
                        <td class="text-uppercase">{{ mov.tipo }}</td>
                        <td class="text-end">{{ "%.2f"|format(mov.cantidad_kg or 0) }} kg</td>
                        <td class="text-end">{{ "%.2f"|format(mov.saldo_resultante or 0) }} kg</td>
                        <td>{{ mov.created_at.strftime("%Y-%m-%d %H:%M") if mov.created_at else '-' }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="card hover-lift note-comments-card">
    <div class="card-body">
        <div class="note-comments-header">
            <h2 class="h6 text-dark mb-0 note-section-title">Comentarios</h2>
        </div>
        <div class="row g-3 note-comments-grid">
            <div class="col-md-6">
                <div class="note-comment-panel">
                    <div class="note-comment-title">Trabajador</div>
                    <div class="note-comment-body">{{ nota.comentarios_trabajador or '-' }}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="note-comment-panel">
                    <div class="note-comment-title">Admin</div>
                    <div class="note-comment-body">{{ nota.comentarios_admin or '-' }}</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function syncCancelComment(formEl) {
        const comments = document.querySelector('textarea[name="comentarios_admin"]');
        const hidden = formEl.querySelector('input[name="comentarios_admin"]');
        if (hidden && comments) {
            hidden.value = comments.value || '';
        }
    }
    const metodoSelect = document.getElementById('metodo_pago_select');
    const cuentaInput = document.getElementById('cuenta_financiera_input');
    function toggleCuenta() {
        if (!metodoSelect || !cuentaInput) return;
        const metodo = (metodoSelect.value || '').toLowerCase();
        const needsAccount = metodo === 'transferencia' || metodo === 'cheque';
        cuentaInput.disabled = !needsAccount;
        cuentaInput.required = needsAccount;
        cuentaInput.placeholder = needsAccount ? 'ID o referencia de cuenta' : 'No aplica para efectivo';
        if (!needsAccount) {
            cuentaInput.value = '';
        }
    }
    if (metodoSelect) {
        metodoSelect.addEventListener('change', toggleCuenta);
        toggleCuenta();
    }
    const pagoMetodo = document.getElementById('pago_metodo_select');
    const pagoCuenta = document.getElementById('pago_cuenta_input');
    function togglePagoCuenta() {
        if (!pagoMetodo || !pagoCuenta) return;
        const metodo = (pagoMetodo.value || '').toLowerCase();
        const needsAccount = metodo === 'transferencia' || metodo === 'cheque';
        pagoCuenta.disabled = !needsAccount;
        pagoCuenta.required = needsAccount;
        pagoCuenta.placeholder = needsAccount ? 'ID o referencia' : 'No aplica';
        if (!needsAccount) {
            pagoCuenta.value = '';
        }
    }
    if (pagoMetodo) {
        pagoMetodo.addEventListener('change', togglePagoCuenta);
        togglePagoCuenta();
    }
</script>
</div>
{% endblock %}
