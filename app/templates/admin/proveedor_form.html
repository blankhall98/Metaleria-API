{% extends "base.html" %}

{% block title %}
    {% if proveedor %}Editar proveedor{% else %}Nuevo proveedor{% endif %} &middot; Admin
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <p class="text-uppercase text-muted small mb-1">Relaciones</p>
        <h1 class="h4 text-white mb-0">
            {% if proveedor %}Editar proveedor{% else %}Nuevo proveedor{% endif %}
        </h1>
    </div>
    <a href="/web/admin/proveedores" class="btn btn-outline-secondary btn-sm">Volver</a>
</div>

{% if error %}
    <div class="alert alert-danger py-2 small">
        {{ error }}
    </div>
{% endif %}

<div class="card hover-lift">
    <div class="card-body">
        <form
            method="post"
            action="{% if proveedor %}/web/admin/proveedores/{{ proveedor.id }}/editar{% else %}/web/admin/proveedores/nuevo{% endif %}"
            class="d-grid gap-3"
        >
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label" for="nombre_completo">Nombre completo</label>
                    <input
                        class="form-control"
                        type="text"
                        id="nombre_completo"
                        name="nombre_completo"
                        required
                        value="{{ proveedor.nombre_completo if proveedor else '' }}"
                    >
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="telefono">Teléfono</label>
                    <input
                        class="form-control"
                        type="text"
                        id="telefono"
                        name="telefono"
                        value="{{ proveedor.telefono if proveedor and proveedor.telefono else '' }}"
                    >
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label" for="correo_electronico">Correo electrónico</label>
                    <input
                        class="form-control"
                        type="email"
                        id="correo_electronico"
                        name="correo_electronico"
                        value="{{ proveedor.correo_electronico if proveedor and proveedor.correo_electronico else '' }}"
                    >
                </div>

                <div class="col-md-6">
                    <label class="form-label">Placas</label>
                    <div class="input-group">
                        <input class="form-control" type="text" id="placa_input" placeholder="ABC123" aria-label="Placa">
                        <button class="btn btn-outline-primary" type="button" id="add_placa_btn">Agregar nueva placa</button>
                    </div>
                    <input type="hidden" name="placas" id="placas_field" value="{{ placas_text if placas_text is defined else (proveedor.placas if proveedor and proveedor.placas else '') }}">
                    <div id="placas_tags" class="d-flex flex-wrap gap-2 mt-2"></div>
                    <div class="form-text">Puedes agregar varias placas. Haz clic en la "x" para eliminar.</div>
                </div>
            </div>

            {% if proveedor %}
                <div class="form-check mb-2">
                    <input
                        class="form-check-input"
                        type="checkbox"
                        id="activo"
                        name="activo"
                        {% if proveedor.activo %}checked{% endif %}
                    >
                    <label class="form-check-label" for="activo">
                        Proveedor activo
                    </label>
                </div>
            {% endif %}

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    Guardar
                </button>
                <a href="/web/admin/proveedores" class="btn btn-outline-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>
<script>
    (function() {
        const input = document.getElementById('placa_input');
        const hidden = document.getElementById('placas_field');
        const container = document.getElementById('placas_tags');
        const btn = document.getElementById('add_placa_btn');

        let placas = [];
        function render() {
            container.innerHTML = '';
            placas.forEach((pl, idx) => {
                const pill = document.createElement('span');
                pill.className = 'placa-chip';
                const label = document.createElement('span');
                label.textContent = pl;
                const close = document.createElement('button');
                close.type = 'button';
                close.className = 'chip-remove';
                close.textContent = '\u00d7';
                close.onclick = () => {
                    placas.splice(idx, 1);
                    syncHidden();
                    render();
                };
                pill.appendChild(label);
                pill.appendChild(close);
                container.appendChild(pill);
            });
            syncHidden();
        }
        function syncHidden() {
            hidden.value = placas.join('\n');
        }
        function addPlaca() {
            const val = (input.value || '').trim().toUpperCase();
            if (!val) return;
            if (!placas.includes(val)) {
                placas.push(val);
                render();
            }
            input.value = '';
            input.focus();
        }
        if (btn) btn.addEventListener('click', addPlaca);
        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPlaca();
                }
            });
        }
        const initial = (hidden.value || '').split(/\r?\n/).map(v => v.trim().toUpperCase()).filter(Boolean);
        placas = Array.from(new Set(initial));
        render();
    })();
</script>
{% endblock %}
