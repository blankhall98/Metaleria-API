{% extends "base.html" %}

{% block title %}Record {{ partner_label }} {{ partner.nombre_completo }}{% endblock %}

{% block content %}
<div class="record-page">
    <div class="page-header">
        <div>
            <p class="text-uppercase text-muted small mb-1">Relaciones</p>
            <h1 class="h4 text-dark mb-0">Record {{ partner_label }}: {{ partner.nombre_completo }}</h1>
            <div class="text-muted small">ID {{ partner.id }} &middot; {{ tipo_operacion_label }}</div>
        </div>
        <div class="d-flex gap-2">
            <a href="/web/admin/{{ partner_base }}" class="btn btn-outline-secondary btn-sm">Volver</a>
            {% set owner_key = 'cliente:' ~ partner.id if partner_base == 'clientes' else 'proveedor:' ~ partner.id %}
            <a href="/web/admin/cuentas?owner_key={{ owner_key }}" class="btn btn-outline-primary btn-sm">Cuentas</a>
            <a href="/web/admin/{{ partner_base }}/{{ partner.id }}/editar" class="btn btn-outline-primary btn-sm">Editar</a>
        </div>
    </div>

    <div class="card hover-lift mb-3">
        <div class="card-body">
            <div class="d-flex flex-column flex-xl-row gap-4">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="chip-strong">Perfil</span>
                        <span class="text-muted small">Datos de contacto</span>
                    </div>
                    <div class="note-meta-grid">
                        <div class="note-meta-item">
                            <span class="note-meta-label">ID</span>
                            <strong>{{ partner.id }}</strong>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">Nombre</span>
                            <strong>{{ partner.nombre_completo }}</strong>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">Telefono</span>
                            <strong>{{ partner.telefono or '-' }}</strong>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">Correo</span>
                            <strong>{{ partner.correo_electronico or '-' }}</strong>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">Placas</span>
                            {% set lista = partner.placas_rel if partner.placas_rel else [] %}
                            {% if lista|length == 0 %}
                                <strong>{{ partner.placas or '-' }}</strong>
                            {% else %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for pl in lista %}
                                        <span class="badge bg-secondary">{{ pl.placa }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">Estado</span>
                            <span class="badge {{ 'bg-success' if partner.activo else 'bg-secondary' }}">
                                {{ 'Activo' if partner.activo else 'Inactivo' }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="d-none d-xl-block vr"></div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="chip-strong">Resumen</span>
                        <span class="text-muted small">Totales contables</span>
                    </div>
                    <div class="note-meta-grid">
                        <div class="note-meta-item">
                            <span class="note-meta-label">Notas totales</span>
                            <strong>{{ summary.total_notas }}</strong>
                            <div class="note-meta-sub">
                                Aprobadas {{ summary.notas_aprobadas }} &middot; En revision {{ summary.notas_revision }}
                            </div>
                            <div class="note-meta-sub">
                                Borrador {{ summary.notas_borrador }} &middot; Canceladas {{ summary.notas_canceladas }}
                            </div>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">{{ total_facturado_label }}</span>
                            <strong>${{ "%.2f"|format(summary.total_facturado or 0) }}</strong>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">{{ total_pagado_label }}</span>
                            <strong>${{ "%.2f"|format(summary.total_pagado or 0) }}</strong>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">{{ saldo_pendiente_label }}</span>
                            <strong class="text-danger">${{ "%.2f"|format(summary.saldo_pendiente or 0) }}</strong>
                        </div>
                        <div class="note-meta-item">
                            <span class="note-meta-label">{{ saldo_favor_label }}</span>
                            <strong class="text-success">${{ "%.2f"|format(summary.saldo_favor or 0) }}</strong>
                        </div>
                    </div>
                    <div class="text-muted small mt-2">Saldos calculados solo con notas aprobadas.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card hover-lift mb-3">
        <div class="card-body">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                <div>
                    <h2 class="h6 text-dark mb-1">Estado de cuenta</h2>
                    <div class="text-muted small">Movimientos cronologicos con saldo acumulado.</div>
                </div>
                <div class="text-muted small">
                    {{ ledger_saldo_label }}:
                    {% if ledger_final >= 0 %}
                        <span class="text-danger fw-semibold">${{ "%.2f"|format(ledger_final) }}</span>
                    {% else %}
                        <span class="text-success fw-semibold">-${{ "%.2f"|format(-ledger_final) }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="text-muted small mt-1">{{ ledger_saldo_help }}</div>
            <div class="table-responsive mt-3">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Movimiento</th>
                        <th>Nota</th>
                        <th>Metodo</th>
                        <th>Cuenta</th>
                        <th class="text-end">Cargo</th>
                        <th class="text-end">Abono</th>
                        <th class="text-end">Saldo</th>
                        <th>Comentario</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for row in ledger_rows %}
                        <tr>
                            <td>{{ row.fecha.strftime("%Y-%m-%d %H:%M") if row.fecha else "-" }}</td>
                            <td>{{ row.tipo }}</td>
                            <td>
                                <div class="fw-semibold">{{ row.folio }}</div>
                                <div class="text-muted small">#{{ row.nota_id }}</div>
                            </td>
                            <td>{{ row.metodo or "-" }}</td>
                            <td>{{ row.cuenta or "-" }}</td>
                            <td class="text-end">${{ "%.2f"|format(row.cargo or 0) }}</td>
                            <td class="text-end">${{ "%.2f"|format(row.abono or 0) }}</td>
                            <td class="text-end">
                                {% if row.saldo >= 0 %}
                                    <span class="text-danger fw-semibold">${{ "%.2f"|format(row.saldo) }}</span>
                                {% else %}
                                    <span class="text-success fw-semibold">-${{ "%.2f"|format(-row.saldo) }}</span>
                                {% endif %}
                            </td>
                            <td class="text-muted small">{{ row.comentario or "-" }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if ledger_rows|length == 0 %}
                <p class="text-muted small mt-3 mb-0">No hay movimientos para generar el estado de cuenta.</p>
            {% endif %}
        </div>
    </div>

    <div class="card hover-lift mb-3">
        <div class="card-body">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                <div>
                    <h2 class="h6 text-dark mb-1">Historial de notas</h2>
                    <div class="text-muted small">
                        Mostrando {{ record_filtered_count }} de {{ record_total_count }} notas registradas.
                    </div>
                </div>
                <form method="get" class="d-flex flex-wrap gap-2 align-items-end">
                    <div>
                        <label class="form-label">Buscar nota</label>
                        <input
                            type="text"
                            class="form-control form-control-sm"
                            name="q"
                            placeholder="ID o folio"
                            value="{{ q }}"
                        >
                    </div>
                    <div class="d-flex gap-2 align-items-end">
                        <button class="btn btn-outline-primary btn-sm" type="submit">Buscar</button>
                        {% if q %}
                            <a href="/web/admin/{{ partner_base }}/{{ partner.id }}/record" class="btn btn-outline-secondary btn-sm">Limpiar</a>
                        {% endif %}
                    </div>
                </form>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Sucursal</th>
                        <th class="text-end">Total $</th>
                        <th class="text-end">Pagado $</th>
                        <th class="text-end">Saldo pendiente</th>
                        <th class="text-end">Saldo a favor</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for row in record_rows %}
                        {% set nota = row.nota %}
                        {% set suc = sucursales.get(nota.sucursal_id) %}
                        <tr>
                            <td>
                                <div class="fw-semibold">{{ row.folio }}</div>
                                <div class="text-muted small">#{{ nota.id }}</div>
                            </td>
                            <td>
                                {% if nota.estado.value == 'BORRADOR' %}
                                    <span class="badge bg-secondary">Borrador</span>
                                {% elif nota.estado.value == 'EN_REVISION' %}
                                    <span class="badge bg-warning text-dark">En revision</span>
                                {% elif nota.estado.value == 'APROBADA' %}
                                    <span class="badge bg-success">Aprobada</span>
                                {% else %}
                                    <span class="badge bg-danger">Cancelada</span>
                                {% endif %}
                            </td>
                            <td>{{ nota.created_at.strftime("%Y-%m-%d %H:%M") if nota.created_at else '-' }}</td>
                            <td>{{ suc.nombre if suc else '-' }}</td>
                            <td class="text-end">${{ "%.2f"|format(row.total or 0) }}</td>
                            <td class="text-end">${{ "%.2f"|format(row.pagado or 0) }}</td>
                            <td class="text-end">
                                {% if row.saldo_aplicable %}
                                    {% if row.saldo_pendiente > 0 %}
                                        <span class="text-danger fw-semibold">${{ "%.2f"|format(row.saldo_pendiente) }}</span>
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if row.saldo_aplicable %}
                                    {% if row.saldo_favor > 0 %}
                                        <span class="text-success fw-semibold">${{ "%.2f"|format(row.saldo_favor) }}</span>
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a href="/web/admin/notas/{{ nota.id }}" class="btn btn-sm btn-outline-primary">Ver nota</a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if record_rows|length == 0 %}
                <p class="text-muted small mt-3 mb-0">No hay notas para este {{ partner_label|lower }}.</p>
            {% endif %}
        </div>
    </div>

    <div class="card hover-lift">
        <div class="card-body">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                <div>
                    <h2 class="h6 text-dark mb-1">Historial de pagos</h2>
                    <div class="text-muted small">Pagos registrados en notas de {{ tipo_operacion_label|lower }}.</div>
                </div>
            </div>
            <div class="table-responsive mt-3">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Nota</th>
                        <th class="text-end">Monto</th>
                        <th>Metodo</th>
                        <th>Cuenta</th>
                        <th>Usuario</th>
                        <th>Comentario</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for pago in pagos %}
                        {% set nota = pago.nota %}
                        <tr>
                            <td>{{ pago.created_at.strftime("%Y-%m-%d %H:%M") if pago.created_at else '-' }}</td>
                            <td>
                                {% if nota %}
                                    <div class="fw-semibold">{{ folio_map.get(nota.id, '-') }}</div>
                                    <div class="text-muted small">#{{ nota.id }}</div>
                                    {% if nota.estado %}
                                        <div class="small mt-1">
                                            {% if nota.estado.value == 'BORRADOR' %}
                                                <span class="badge bg-secondary">Borrador</span>
                                            {% elif nota.estado.value == 'EN_REVISION' %}
                                                <span class="badge bg-warning text-dark">En revision</span>
                                            {% elif nota.estado.value == 'APROBADA' %}
                                                <span class="badge bg-success">Aprobada</span>
                                            {% else %}
                                                <span class="badge bg-danger">Cancelada</span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">${{ "%.2f"|format(pago.monto or 0) }}</td>
                            <td>{{ pago.metodo_pago or '-' }}</td>
                            <td>{{ pago.cuenta.display_label if pago.cuenta else (pago.cuenta_financiera or '-') }}</td>
                            <td>
                                {% if pago.usuario %}
                                    <div class="fw-semibold">{{ pago.usuario.nombre_completo or pago.usuario.username }}</div>
                                    <div class="text-muted small">{{ pago.usuario.username }}</div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-muted">{{ pago.comentario or '-' }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if pagos|length == 0 %}
                <p class="text-muted small mt-3 mb-0">No hay pagos registrados.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
